import { useRef, useState } from 'react'
import Head from 'next/head'
import Image from 'next/image'
import { useQuery } from 'react-query'
// state
import { useRecoilValue } from 'recoil'
import { sidebarState } from 'src/state/sidebarState'
// hooks
import useAuthState from 'src/hooks/useAuthState'
// fetch
import { db } from 'src/config/firebaseConfig'
import { doc, getDoc } from 'firebase/firestore'
import { findDeclarations } from 'src/lib/declarations'
// components
import Layout from '@components/Layout'
import Sidebar from '@components/Sidebar'
import Header from '@components/Header/Header'
import AddModal from '@components/Modal/AddModal'
import FloatingActionButton from '@components/FloatingActionButton'
import DraggablePoint from '@components/DraggablePoint'
import Spinner from '@components/Spinner/Spinner'
import ReadModal from '@components/Modal/ReadModal'
import { SelectedDeclarationType } from 'src/types/types'

interface HomeProps {
  count: number
}

export default function Home({ count }: HomeProps) {
  const sidebarOpen = useRecoilValue(sidebarState)
  const [addModalOepn, setAddModalOepn] = useState(false)
  const [readModalOepn, setReadModalOepn] = useState(false)
  const [selectedDeclaration, setSelectedDeclaration] =
    useState<SelectedDeclarationType | null>(null)
  const [user, _, isLoading] = useAuthState()
  const userId = user?.uid
  const boardRef = useRef<HTMLDivElement>(null)
  const containerX = useRef(0)
  const containerY = useRef(0)

  // useEffect(() => {
  //   if (boardRef.current !== null) {
  //     const { width, height } = boardRef.current.getBoundingClientRect()
  //     console.log('컨테이너 너비와 높이: ', width, height)
  //   }
  // }, [])

  const { isLoading: dataLoading, data } = useQuery(
    ['findDeclarations', userId],
    () => findDeclarations(userId!),
    {
      enabled: !!userId,
    }
  )

  const onClickHandler = ({ tag, declaration }: SelectedDeclarationType) => {
    setReadModalOepn(true)
    setSelectedDeclaration({
      tag,
      declaration,
    })
  }

  return (
    <Layout>
      <Head>
        <title>천국열쇠 챌린지</title>
        <meta name="description" content="Generated by create next app" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <link rel="icon" href="/favicon.ico" />
      </Head>

      <Image
        src={'/images/tree.png'}
        alt="tree images for background"
        width={1501}
        height={1500}
        style={{
          position: 'absolute',
          top: '50%',
          left: 0,
          transform: 'translateY(-50%)',
        }}
        priority={true}
      />
      {sidebarOpen && <Sidebar />}

      <div className="relative w-full h-[calc(100%-80px)] py-8 px-4">
        <Header isLoading={isLoading} user={user} count={count} />

        <div className="w-full h-full" ref={boardRef}>
          {dataLoading ? (
            <Spinner />
          ) : (
            data?.map((item, index) => (
              <DraggablePoint
                key={item.id}
                boardRef={boardRef}
                initialX={item.initialX}
                initialY={item.initialY}
                index={index + 1}
                tag={item.tag}
                onClickHandler={() =>
                  onClickHandler({
                    tag: item.tag,
                    declaration: item.declaration,
                  })
                }
              />
            ))
          )}
        </div>
        <FloatingActionButton setOepn={setAddModalOepn} />
        {addModalOepn && <AddModal setOepn={setAddModalOepn} />}
        {readModalOepn && (
          <ReadModal
            setOepn={setReadModalOepn}
            selectedDeclaration={selectedDeclaration}
          />
        )}
      </div>
    </Layout>
  )
}

export async function getServerSideProps() {
  let count
  const docSnap = await getDoc(doc(db, 'all-declarations', 'totalInfo'))
  if (docSnap.exists()) {
    count = docSnap.data().published
  }

  return {
    props: {
      count,
    },
  }
}
